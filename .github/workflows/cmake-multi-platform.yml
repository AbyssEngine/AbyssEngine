# This starter workflow is for a CMake project running on multiple platforms. There is a different starter workflow if you just want a single platform.
# See: https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml
name: CMake on multiple platforms

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]

jobs:
    build:
        name: ${{ matrix.name }}
        runs-on: ${{ matrix.os }}

        strategy:
            fail-fast: false

            matrix:
                os: [ ubuntu-latest, windows-latest, macos-latest ]
                build_type: [ Release ]
                c_compiler: [ gcc, clang, cl ]
                include:

                    -   name: Windows
                        os: windows-latest
                        c_compiler: cl
                        cpp_compiler: cl
                        triplet: x64-windows-release
                    -   name: Ubuntu GCC
                        os: ubuntu-latest
                        c_compiler: gcc
                        cpp_compiler: g++
                        triplet: x64-linux-release
                    -   name: MacOS
                        os: macos-13
                        c_compiler: clang
                        cpp_compiler: clang++
                        triplet: x64-osx-release

                exclude:
                    -   os: windows-latest
                        c_compiler: gcc
                    -   os: windows-latest
                        c_compiler: clang
                    -   os: ubuntu-latest
                        c_compiler: cl
                    -   os: macos-latest
                        c_compiler: cl
                    -   os: macos-latest
                        c_compiler: gcc
        steps:
            -   uses: actions/checkout@v3
                with:
                    submodules: recursive

            -   name: Set reusable strings
                id: strings
                shell: bash
                run: |
                    echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

            -   uses: lukka/get-cmake@latest
            -   name: Setup anew (or from cache) vcpkg (and does not build any package)
                uses: lukka/run-vcpkg@v11
                with:
                    vcpkgGitCommitId: 'f56238700757aa05975e41fa835739c632810f3f'
                    vcpkgJsonGlob: "**/vcpkg.json"


            -   name: Configure CMake
                run: >
                    cmake
                    -GNinja
                    -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake
                    -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }}
                    -B ${{ steps.strings.outputs.build-output-dir }}
                    -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}
                    -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
                    -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
                    -S ${{ github.workspace }}

            -   name: Build
                run: cmake --build ${{ steps.strings.outputs.build-output-dir }} --config ${{ matrix.build_type }}

        env:
            VCPKG_DEFAULT_TRIPLET: ${{ matrix.triplet }}
            VCPKG_DEFAULT_HOST_TRIPLET: ${{ matrix.triplet }}

